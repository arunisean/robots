# Web3钱包认证系统需求文档

## 介绍

本项目需要修复Web3钱包认证系统中的签名验证问题。当前系统在用户尝试登录时出现"签名验证失败"错误，导致用户无法成功认证。需要重点解决前端personal_sign方法与后端ethers.verifyMessage方法之间的兼容性问题。

## 需求

### 需求1：修复签名验证兼容性问题

**用户故事：** 作为Web3用户，我希望能够成功完成钱包签名认证，而不会遇到"签名验证失败"的错误，以便正常访问平台功能。

#### 验收标准

1. 当用户使用personal_sign方法签名时，后端应能够正确验证签名
2. 当签名消息格式正确时，ethers.verifyMessage应能够恢复出正确的钱包地址
3. 当签名验证成功时，系统应返回有效的JWT token
4. 当签名验证失败时，系统应提供详细的错误信息用于调试
5. 当消息格式不匹配时，系统应明确指出格式错误
6. 如果nonce过期或无效，系统应提示用户重新获取nonce

### 需求2：消息格式标准化

**用户故事：** 作为开发者，我希望前端和后端使用完全一致的消息格式，以确保签名验证的准确性。

#### 验收标准

1. 当生成签名消息时，前端和后端应使用相同的createSignMessage函数
2. 当消息包含特殊字符时，编码方式应保持一致
3. 当消息包含换行符时，前端和后端应使用相同的换行符格式
4. 当验证消息格式时，系统应进行严格的字符串比较
5. 当消息格式不匹配时，系统应记录详细的差异信息
6. 如果消息编码有问题，系统应提供编码转换的调试信息

### 需求3：签名验证调试和日志

**用户故事：** 作为开发者，我希望有详细的调试信息来诊断签名验证失败的原因，以便快速定位和解决问题。

#### 验收标准

1. 当签名验证失败时，系统应记录原始消息、签名和预期地址
2. 当ethers.verifyMessage抛出异常时，系统应捕获并记录详细错误信息
3. 当地址不匹配时，系统应显示预期地址和实际恢复的地址
4. 当调试模式启用时，系统应输出签名验证的每个步骤
5. 当nonce验证失败时，系统应显示存储的nonce和提取的nonce
6. 如果消息编码有问题，系统应显示消息的十六进制表示

### 需求4：Nonce管理和验证

**用户故事：** 作为系统管理员，我希望nonce管理机制能够正确工作，防止重放攻击并确保签名的唯一性。

#### 验收标准

1. 当生成nonce时，系统应确保nonce的唯一性和随机性
2. 当存储nonce时，系统应设置合理的过期时间（如5分钟）
3. 当验证nonce时，系统应检查nonce是否存在且未过期
4. 当nonce使用后，系统应立即删除以防止重复使用
5. 当nonce过期时，系统应提示用户重新获取nonce
6. 如果Redis不可用，系统应有备用的nonce存储机制

### 需求5：JWT Token生成和验证

**用户故事：** 作为认证用户，我希望在签名验证成功后能够获得有效的JWT token，以便访问受保护的API端点。

#### 验收标准

1. 当签名验证成功时，系统应生成包含用户ID和钱包地址的JWT token
2. 当生成token时，系统应设置合理的过期时间（如7天）
3. 当返回token时，系统应同时返回用户基本信息
4. 当token用于API请求时，认证中间件应能够正确验证token
5. 当token过期时，系统应返回明确的过期错误信息
6. 如果token格式无效，系统应返回详细的验证错误

