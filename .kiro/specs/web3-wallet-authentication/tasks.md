# Web3签名验证修复实施计划

## 阶段1：问题诊断和修复（优先级：高）

### 1. 添加详细调试日志系统

- [ ] 1.1 增强前端签名过程日志记录
  - 在WalletContext.tsx的login函数中添加详细日志
  - 记录nonce获取、消息生成、签名过程的每个步骤
  - 添加消息内容、长度、编码格式的日志输出
  - 记录签名结果和钱包地址信息
  - _需求: 3.1, 3.4_

- [ ] 1.2 增强后端签名验证日志记录
  - 在auth.ts的login路由中添加详细验证日志
  - 记录接收到的消息、签名、钱包地址
  - 添加ethers.verifyMessage的执行过程日志
  - 记录地址恢复和比较的详细信息
  - _需求: 3.2, 3.3_

- [ ] 1.3 实现调试模式开关
  - 添加环境变量控制调试日志输出
  - 在开发环境默认启用详细日志
  - 在生产环境提供可选的调试模式
  - 实现日志级别控制和过滤机制
  - _需求: 3.4_

### 2. 验证和修复消息格式一致性

- [ ] 2.1 检查消息生成函数一致性
  - 验证前后端都使用相同的createSignMessage函数
  - 检查shared包中的crypto.ts实现
  - 确保消息模板格式完全一致
  - 验证换行符和特殊字符处理
  - _需求: 2.1, 2.2_

- [ ] 2.2 修复消息编码问题
  - 检查UTF-8编码处理是否一致
  - 验证消息字节长度计算
  - 修复任何编码转换问题
  - 确保消息哈希计算一致性
  - _需求: 2.3, 2.4_

- [ ] 2.3 标准化nonce格式和验证
  - 检查nonce生成算法的一致性
  - 验证nonce在消息中的嵌入格式
  - 修复nonce提取和验证逻辑
  - 确保nonce过期时间处理正确
  - _需求: 4.1, 4.2, 4.3_

### 3. 修复签名验证兼容性问题

- [ ] 3.1 验证personal_sign与ethers.verifyMessage兼容性
  - 测试personal_sign生成的签名格式
  - 验证ethers.verifyMessage能否正确处理
  - 检查签名前缀和格式处理
  - 修复任何兼容性问题
  - _需求: 1.1, 1.2_

- [ ] 3.2 修复地址大小写处理问题
  - 确保地址比较时统一使用小写
  - 修复地址格式验证逻辑
  - 处理checksum地址格式
  - 验证地址恢复的准确性
  - _需求: 1.3, 1.4_

- [ ] 3.3 实现签名验证错误处理
  - 捕获ethers.verifyMessage的所有异常
  - 提供详细的错误信息和调试数据
  - 实现签名验证失败的恢复机制
  - 添加重试逻辑和用户提示
  - _需求: 1.5, 1.6_

## 阶段2：增强错误处理和调试（优先级：中）

### 4. 实现详细错误分类和处理

- [ ] 4.1 创建签名验证错误分类系统
  - 定义SignatureVerificationErrorType枚举
  - 实现错误类型检测和分类逻辑
  - 创建错误详情记录和存储机制
  - 添加错误统计和分析功能
  - _需求: 3.1, 3.2_

- [ ] 4.2 实现用户友好的错误消息
  - 创建错误消息映射表
  - 实现技术错误到用户消息的转换
  - 添加错误恢复建议和操作指导
  - 实现多语言错误消息支持
  - _需求: 3.3, 3.4_

- [ ] 4.3 开发错误恢复策略
  - 实现自动重试机制
  - 创建错误恢复操作流程
  - 添加用户手动恢复选项
  - 实现错误状态清理和重置
  - _需求: 3.5, 3.6_

### 5. 添加调试API端点

- [ ] 5.1 创建签名验证调试接口
  - 实现POST /auth/debug/verify-signature端点
  - 提供详细的签名验证步骤信息
  - 返回ethers版本和兼容性信息
  - 添加签名格式和编码检查
  - _需求: 3.1, 3.2_

- [ ] 5.2 实现nonce状态查询接口
  - 创建GET /auth/debug/nonce/:address端点
  - 提供nonce存在性和过期状态信息
  - 返回剩余有效时间和调试数据
  - 添加nonce历史记录查询功能
  - _需求: 4.4, 4.5_

- [ ] 5.3 开发验证步骤跟踪系统
  - 实现验证过程的详细步骤记录
  - 创建验证时间线和性能分析
  - 添加验证失败点定位功能
  - 实现验证数据的可视化展示
  - _需求: 3.3, 3.4_

### 6. 优化JWT Token生成和验证

- [ ] 6.1 增强JWT token生成逻辑
  - 验证token payload结构的正确性
  - 确保userId和walletAddress字段存在
  - 添加token生成时间和过期时间
  - 实现token签名密钥的安全管理
  - _需求: 5.1, 5.2_

- [ ] 6.2 修复认证中间件token验证
  - 检查authMiddleware的JWT解析逻辑
  - 修复token字段映射问题（userId vs sub）
  - 确保用户信息正确附加到请求
  - 添加token验证失败的详细日志
  - _需求: 5.3, 5.4_

- [ ] 6.3 实现token刷新和过期处理
  - 添加token自动刷新机制
  - 实现过期token的优雅处理
  - 创建token续期和撤销功能
  - 添加token状态监控和告警
  - _需求: 5.5, 5.6_

## 阶段3：测试和验证（优先级：中）

### 7. 创建全面的测试套件

- [ ] 7.1 实现消息格式一致性测试
  - 测试前后端createSignMessage函数一致性
  - 验证消息编码和格式处理
  - 测试特殊字符和换行符处理
  - 创建消息格式回归测试
  - _需求: 2.1, 2.2_

- [ ] 7.2 开发签名验证兼容性测试
  - 测试personal_sign与ethers.verifyMessage兼容性
  - 验证不同钱包的签名格式支持
  - 测试地址恢复和比较逻辑
  - 创建签名验证性能测试
  - _需求: 1.1, 1.2_

- [ ]* 7.3 实现端到端认证流程测试
  - 创建完整的登录流程自动化测试
  - 测试各种错误场景和恢复机制
  - 验证token生成和验证流程
  - 实现并发认证测试
  - _需求: 5.1, 5.2_

### 8. 实施监控和日志系统

- [ ] 8.1 部署生产环境监控
  - 实现签名验证成功率监控
  - 创建错误率和类型分布统计
  - 添加响应时间和性能指标
  - 实现实时告警和通知机制
  - _需求: 3.1, 3.2_

- [ ] 8.2 创建错误跟踪和分析系统
  - 集成错误监控服务（如Sentry）
  - 实现用户行为和错误关联分析
  - 创建错误趋势和模式识别
  - 添加错误影响评估和优先级
  - _需求: 3.3, 3.4_

- [ ]* 8.3 实现性能基准测试
  - 创建签名验证性能基准
  - 测试并发处理能力
  - 验证系统可用性和稳定性
  - 实现性能回归测试
  - _需求: 5.1, 5.2_

