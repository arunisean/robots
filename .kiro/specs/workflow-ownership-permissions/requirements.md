# 工作流所有权和权限管理需求文档

## 介绍

当前系统使用Web3钱包地址作为用户身份标识，但工作流的所有权和权限管理不够明确。用户无法删除自己创建的工作流，也看到了无法操作的测试数据。本需求旨在建立清晰的所有权模型和权限系统，确保用户只能管理自己的资源，同时为管理员提供全局管理能力。

## 需求

### 需求1：Web3身份到用户ID的映射

**用户故事：** 作为使用Web3钱包登录的用户，我希望系统能够将我的钱包地址映射到唯一的用户ID，以便系统能够追踪我创建的资源。

#### 验收标准

1. 当用户首次使用钱包地址登录时，系统应自动创建对应的用户记录
2. 当用户再次登录时，系统应通过钱包地址查找到对应的用户ID
3. 当用户创建工作流时，系统应记录创建者的用户ID（而非钱包地址）
4. 当查询用户信息时，系统应能够通过钱包地址或用户ID查找
5. 当用户切换钱包地址时，系统应将其视为不同的用户
6. 如果钱包地址格式无效，系统应拒绝创建用户并返回错误

### 需求2：工作流所有权管理

**用户故事：** 作为工作流创建者，我希望系统能够明确标识我创建的工作流，并且只允许我修改和删除自己的工作流。

#### 验收标准

1. 当用户创建工作流时，系统应将用户ID记录为工作流的所有者
2. 当用户查看工作流列表时，系统应只显示该用户创建的工作流
3. 当用户尝试修改工作流时，系统应验证用户是否为所有者
4. 当用户尝试删除工作流时，系统应验证用户是否为所有者
5. 当非所有者尝试操作工作流时，系统应返回403权限错误
6. 如果工作流所有者信息缺失，系统应将其视为孤儿资源并标记

### 需求3：删除工作流功能

**用户故事：** 作为工作流所有者，我希望能够删除自己创建的工作流，以便清理不需要的资源。

#### 验收标准

1. 当用户点击删除按钮时，系统应显示确认对话框
2. 当用户确认删除时，系统应验证用户权限
3. 当权限验证通过时，系统应删除工作流及其相关数据
4. 当工作流正在执行时，系统应先停止执行再删除
5. 当删除成功时，系统应从列表中移除该工作流并显示成功消息
6. 如果删除失败，系统应显示错误信息并保持工作流不变

### 需求4：管理员角色和权限

**用户故事：** 作为系统管理员，我希望能够查看和管理所有用户的工作流，以便进行系统维护和问题排查。

#### 验收标准

1. 当管理员登录时，系统应识别其管理员角色
2. 当管理员查看工作流列表时，系统应显示所有用户的工作流
3. 当管理员查看工作流详情时，系统应显示所有者信息
4. 当管理员修改工作流时，系统应允许操作并记录管理员操作日志
5. 当管理员删除工作流时，系统应允许操作并通知工作流所有者
6. 如果管理员权限被撤销，系统应立即限制其访问权限

### 需求5：测试数据隔离

**用户故事：** 作为普通用户，我希望不会看到系统的测试数据和其他用户的工作流，以便获得清晰的用户体验。

#### 验收标准

1. 当普通用户查询工作流时，系统应过滤掉测试用户创建的数据
2. 当测试环境运行时，系统应使用独立的测试用户ID
3. 当生产环境运行时，系统应禁止使用测试用户ID创建数据
4. 当管理员查看时，系统应提供选项显示或隐藏测试数据
5. 当清理测试数据时，系统应提供批量删除测试数据的功能
6. 如果测试数据泄露到生产环境，系统应提供迁移工具

### 需求6：公共API权限限制

**用户故事：** 作为系统架构师，我希望公共API端点有明确的权限限制，防止未授权的数据访问和操作。

#### 验收标准

1. 当调用公共API创建工作流时，系统应要求有效的认证token
2. 当调用公共API查询工作流时，系统应只返回当前用户的数据
3. 当调用公共API修改工作流时，系统应验证所有权
4. 当调用公共API删除工作流时，系统应验证所有权
5. 当token无效或过期时，系统应返回401未授权错误
6. 如果检测到权限绕过尝试，系统应记录安全事件并阻止操作

### 需求7：工作流共享功能（未来扩展）

**用户故事：** 作为工作流创建者，我希望能够将工作流共享给其他用户，让他们可以查看或协作编辑。

#### 验收标准

1. 当用户选择共享工作流时，系统应提供权限级别选择（只读/编辑）
2. 当设置共享权限时，系统应记录被共享用户的ID和权限级别
3. 当被共享用户访问工作流时，系统应根据权限级别允许操作
4. 当所有者撤销共享时，系统应立即移除被共享用户的访问权限
5. 当被共享用户尝试删除工作流时，系统应拒绝操作
6. 如果共享链接过期，系统应自动撤销访问权限

### 需求8：审计日志和操作追踪

**用户故事：** 作为系统管理员，我希望能够追踪所有工作流的操作历史，以便进行安全审计和问题排查。

#### 验收标准

1. 当用户创建工作流时，系统应记录创建时间和用户ID
2. 当用户修改工作流时，系统应记录修改时间、用户ID和变更内容
3. 当用户删除工作流时，系统应记录删除时间和用户ID
4. 当管理员操作工作流时，系统应特别标记管理员操作
5. 当查询审计日志时，系统应支持按用户、时间、操作类型过滤
6. 如果审计日志丢失，系统应发出警报并尝试恢复

### 需求9：权限错误提示优化

**用户故事：** 作为用户，当我尝试操作无权限的资源时，我希望收到清晰的错误提示，了解原因和解决方案。

#### 验收标准

1. 当用户尝试访问他人的工作流时，系统应显示"无权限访问"错误
2. 当用户尝试修改他人的工作流时，系统应显示"只有所有者可以修改"错误
3. 当用户尝试删除他人的工作流时，系统应显示"只有所有者可以删除"错误
4. 当token过期时，系统应提示"登录已过期，请重新登录"
5. 当未登录用户访问时，系统应提示"请先连接钱包登录"
6. 如果是系统错误导致权限检查失败，系统应显示通用错误并记录日志

### 需求10：数据库迁移和现有数据处理

**用户故事：** 作为系统维护者，我希望能够平滑迁移现有数据，为已存在的工作流分配正确的所有者。

#### 验收标准

1. 当执行数据迁移时，系统应为所有现有工作流分配所有者
2. 当无法确定所有者时，系统应将工作流分配给默认管理员账户
3. 当迁移完成时，系统应生成迁移报告显示处理的记录数
4. 当迁移失败时，系统应回滚所有更改并保持数据一致性
5. 当迁移后验证时，系统应确保所有工作流都有有效的所有者ID
6. 如果发现数据不一致，系统应提供修复工具
