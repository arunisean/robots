# Implementation Plan

## Overview

本实施计划将构建一个完整的回测系统，支持策略在历史数据上的测试、参数优化、性能分析和报告生成。计划分为多个阶段，从核心回测功能开始，逐步添加高级功能如参数优化、可视化和实时回测。

## Task List

- [x] 1. 增强BacktestEngine核心功能


  - [ ] 1.1 实现历史数据加载
    - 集成Binance API加载K线数据
    - 实现数据验证和清洗
    - 添加数据缺失处理逻辑
    - 支持多个交易对的数据加载
    - _Requirements: 2.1, 2.5_
  
  - [ ] 1.2 优化数据生成器
    - 改进价格生成算法，更真实地模拟市场
    - 添加成交量生成逻辑
    - 实现市场事件模拟（突发波动、趋势转换）
    - 支持相关性资产的数据生成
    - _Requirements: 2.2_
  
  - [ ] 1.3 实现自定义数据上传
    - 创建CSV解析器
    - 验证数据格式和完整性
    - 存储用户上传的数据文件
    - 支持多种时间格式和列映射
    - _Requirements: 2.3_
  
  - [ ] 1.4 增强回测执行逻辑
    - 添加滑点模拟
    - 实现更精确的手续费计算
    - 支持部分成交模拟
    - 添加市场深度模拟
    - _Requirements: 1.1, 1.2_
  
  - [ ]* 1.5 编写BacktestEngine单元测试
    - 测试数据加载各种场景
    - 测试交易执行逻辑
    - 测试指标计算准确性
    - 测试边界条件和错误处理
    - _Requirements: 1.1, 1.2, 1.3_



- [ ] 2. 实现BinanceDataDownloader服务
  - [ ] 2.1 创建BinanceDataDownloader类
    - 实现Binance公开数据URL构建逻辑
    - 支持spot、futures-um、futures-cm、options市场
    - 支持所有K线时间周期（1m到1mo）
    - 实现日期范围到文件列表的转换
    - _Requirements: 2.1.1, 2.1.2, 2.1.3_
  
  - [ ] 2.2 实现文件下载引擎
    - 使用axios下载ZIP文件
    - 实现并发下载控制（可配置并发数）
    - 添加下载进度跟踪
    - 实现断点续传支持
    - 添加下载速度限制选项
    - _Requirements: 2.1.4, 2.1.5_
  
  - [ ] 2.3 实现文件验证和解压
    - 下载并验证CHECKSUM文件
    - 验证ZIP文件完整性
    - 自动解压ZIP文件
    - 解析CSV格式的K线数据
    - 验证数据格式正确性
    - _Requirements: 2.1.6, 2.1.7_
  
  - [ ] 2.4 实现下载任务管理
    - 创建data_download_jobs表操作
    - 实现任务队列管理
    - 支持任务暂停和恢复
    - 记录失败文件并支持重试
    - 实现增量下载（跳过已有文件）
    - _Requirements: 2.1.8, 2.1.9_
  
  - [ ] 2.5 实现数据存储和索引
    - 创建historical_datasets表操作
    - 将CSV数据转换为高效存储格式（Parquet或数据库）
    - 建立时间序列索引
    - 记录数据集元数据


    - 实现数据去重逻辑
    - _Requirements: 2.1.7, 2.1.10_

- [ ] 3. 实现HistoricalDataManager服务
  - [ ] 3.1 创建HistoricalDataManager类
    - 实现数据集列表查询
    - 支持按市场类型、交易对、时间周期筛选
    - 实现数据集详情查询
    - 添加数据集搜索功能
    - _Requirements: 2.2.3, 2.2.5_
  
  - [ ] 3.2 实现数据完整性验证
    - 检查文件是否存在和可读
    - 验证数据时间连续性
    - 检测数据缺口
    - 验证数据格式正确性
    - 生成验证报告
    - _Requirements: 2.2.8_
  
  - [ ] 3.3 实现存储管理功能
    - 计算总存储使用量
    - 按维度统计存储分布
    - 实现数据集删除功能
    - 添加批量删除支持
    - 实现存储空间警报
    - _Requirements: 2.2.6, 2.2.7_
  
  - [ ] 3.4 实现K线数据查询
    - 根据交易对、时间周期、时间范围查询K线
    - 支持跨多个数据集的查询
    - 实现数据聚合（如1m聚合为5m）
    - 添加查询结果缓存
    - 优化大范围查询性能
    - _Requirements: 2.4_
  
  - [ ] 3.5 实现元数据导出
    - 导出所有数据集信息为JSON
    - 导出为CSV格式
    - 包含统计信息和时间线
    - 支持筛选导出
    - _Requirements: 2.2.9_

- [ ] 4. 实现DataProvider服务
  - [ ] 4.1 创建DataProvider类
    - 实现统一的数据加载接口
    - 集成HistoricalDataManager
    - 支持多种数据源（历史、生成、自定义）
    - 实现数据源自动选择逻辑
    - 添加数据预处理功能
    - _Requirements: 2.1, 2.2, 2.3_
  
  - [ ] 4.2 实现Redis缓存层
    - 集成Redis客户端
    - 实现缓存键生成策略
    - 添加缓存过期管理
    - 实现缓存预热功能
    - _Requirements: 2.4, 12.2_
  
  - [ ] 4.3 实现数据加载优化
    - 实现懒加载策略
    - 添加数据分页加载
    - 实现内存使用限制
    - 优化大数据集加载性能
    - _Requirements: 2.1, 12.2_

- [ ] 5. 构建MetricsCalculator服务
  - [ ] 3.1 实现性能指标计算
    - 计算总收益率和年化收益率
    - 计算夏普比率、索提诺比率
    - 计算卡尔玛比率
    - 计算胜率和盈利因子
    - _Requirements: 3.1_
  
  - [ ] 3.2 实现风险指标计算
    - 计算最大回撤和平均回撤
    - 计算回撤持续时间
    - 计算VaR和CVaR
    - 计算波动率和Beta值
    - _Requirements: 3.2, 11.1, 11.3_
  
  - [ ] 3.3 实现交易统计计算
    - 计算交易频率和持仓时间
    - 计算连续盈亏次数
    - 计算最大盈利和最大亏损
    - 计算期望值和标准差
    - _Requirements: 3.3, 3.5_
  
  - [ ] 3.4 实现月度收益计算
    - 按月聚合收益数据
    - 计算月度收益率
    - 生成月度统计摘要
    - 识别最佳和最差月份
    - _Requirements: 3.4_
  
  - [ ]* 3.5 编写指标计算测试
    - 使用已知结果验证计算
    - 测试边界情况
    - 验证数学公式正确性
    - 性能基准测试
    - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6. 开发BacktestOrchestrator服务
  - [ ] 4.1 创建BacktestOrchestrator类
    - 实现回测任务管理
    - 协调各个服务组件
    - 实现任务队列管理
    - 添加进度跟踪功能
    - _Requirements: 1.1, 1.4, 12.3_
  
  - [ ] 4.2 实现任务队列系统
    - 使用Bull队列管理回测任务
    - 实现优先级队列
    - 添加任务重试逻辑
    - 实现并发限制
    - _Requirements: 12.3, 12.4_
  
  - [ ] 4.3 实现进度跟踪和通知
    - 实时更新任务进度
    - 通过WebSocket推送进度
    - 完成时发送通知
    - 记录执行日志
    - _Requirements: 1.4_
  
  - [ ] 4.4 实现结果持久化
    - 保存回测结果到数据库
    - 存储图表数据
    - 实现结果压缩
    - 添加结果版本控制
    - _Requirements: 8.1_

- [ ] 7. 实现ParameterOptimizer服务
  - [ ] 5.1 实现网格搜索优化
    - 生成参数组合网格
    - 并行执行多个回测
    - 按指标排序结果
    - 生成优化摘要
    - _Requirements: 5.1, 5.2, 5.3_
  
  - [ ] 5.2 实现随机搜索优化
    - 随机采样参数空间
    - 实现早停策略
    - 支持自定义采样分布
    - 记录搜索历史
    - _Requirements: 5.1, 5.2_
  
  - [ ] 5.3 实现前进分析
    - 分割训练和测试期
    - 滚动窗口优化
    - 计算性能退化
    - 检测过拟合
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [ ] 5.4 实现参数热力图生成
    - 计算参数对性能的影响
    - 生成2D热力图数据
    - 识别最优参数区域
    - 可视化参数敏感性
    - _Requirements: 5.5_
  
  - [ ] 5.5 优化并行处理性能
    - 使用Worker线程池
    - 实现任务分片
    - 添加资源监控
    - 动态调整并发数
    - _Requirements: 5.6, 12.1_

- [ ] 8. 构建Visualizer服务
  - [ ] 6.1 实现权益曲线生成
    - 生成时间序列数据
    - 添加基准对比线
    - 标注关键事件
    - 支持多策略对比
    - _Requirements: 4.1_
  
  - [ ] 6.2 实现回撤图生成
    - 计算回撤百分比
    - 标注最大回撤点
    - 显示回撤恢复时间
    - 添加回撤统计信息
    - _Requirements: 4.2_
  
  - [ ] 6.3 实现交易分布图
    - 生成盈亏分布直方图
    - 显示累积分布曲线
    - 标注统计指标
    - 支持按时间段筛选
    - _Requirements: 4.3_
  
  - [ ] 6.4 实现价格图表与交易标注
    - 绘制K线图
    - 标注买入卖出点
    - 显示持仓区间
    - 添加技术指标叠加
    - _Requirements: 4.4_
  
  - [ ] 6.5 实现月度收益热力图
    - 生成月度收益矩阵
    - 颜色编码收益率
    - 添加年度汇总
    - 支持交互式查看
    - _Requirements: 4.5_
  
  - [ ] 6.6 集成图表库
    - 选择和集成Chart.js或ECharts
    - 实现服务端渲染
    - 生成静态图片
    - 支持响应式设计
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 9. 开发ReportGenerator服务
  - [ ] 7.1 实现PDF报告生成
    - 集成PDF生成库（puppeteer或pdfkit）
    - 设计报告模板
    - 嵌入图表和表格
    - 支持中英文
    - _Requirements: 7.1, 7.4_
  
  - [ ] 7.2 实现CSV导出
    - 导出交易记录
    - 导出权益曲线数据
    - 导出性能指标
    - 支持自定义列
    - _Requirements: 7.2_
  
  - [ ] 7.3 实现JSON导出
    - 导出完整回测结果
    - 包含所有元数据
    - 支持压缩格式
    - 版本化数据结构
    - _Requirements: 7.3_
  
  - [ ] 7.4 实现HTML报告生成
    - 创建交互式HTML报告
    - 嵌入JavaScript图表
    - 支持打印样式
    - 添加导航和目录
    - _Requirements: 7.1_
  
  - [ ] 7.5 实现报告存储和管理
    - 存储生成的报告文件
    - 实现文件访问控制
    - 添加下载链接生成
    - 自动清理过期报告
    - _Requirements: 7.1, 7.2, 7.3_

- [ ] 10. 创建历史数据管理API端点
  - [ ] 10.1 实现数据下载端点（仅限本地访问）
    - POST /api/admin/data/download - 启动数据下载任务
    - GET /api/admin/data/download/:jobId - 获取下载状态
    - DELETE /api/admin/data/download/:jobId - 取消下载
    - GET /api/admin/data/download - 列出所有下载任务
    - 添加IP白名单中间件（仅允许localhost）
    - _Requirements: 2.1.1, 2.1.4, 2.1.5, 2.2.2_
  
  - [ ] 10.2 实现数据集管理端点（仅限本地访问）
    - GET /api/admin/data/datasets - 列出所有数据集
    - GET /api/admin/data/datasets/:id - 获取数据集详情
    - DELETE /api/admin/data/datasets/:id - 删除数据集
    - POST /api/admin/data/datasets/:id/verify - 验证数据集
    - GET /api/admin/data/storage - 获取存储统计
    - _Requirements: 2.2.3, 2.2.4, 2.2.6, 2.2.7, 2.2.8_
  
  - [ ] 10.3 实现数据查询端点（仅限本地访问）
    - GET /api/admin/data/symbols - 列出可用交易对
    - GET /api/admin/data/availability - 查询数据可用性
    - GET /api/admin/data/klines - 查询K线数据
    - GET /api/admin/data/export - 导出元数据
    - _Requirements: 2.2.9, 2.2.10_
  
  - [ ] 10.4 实现访问控制中间件
    - 创建localhostOnly中间件
    - 检查请求IP是否为127.0.0.1或::1
    - 返回403 Forbidden给非本地请求
    - 记录未授权访问尝试
    - _Requirements: 2.2.2_

- [ ] 11. 创建回测API端点
  - [ ] 11.1 实现数据集查询端点（公开访问）
    - GET /api/data/datasets - 列出可用数据集（只读）
    - GET /api/data/datasets/available - 查询特定条件的可用数据
    - GET /api/data/symbols - 列出支持的交易对
    - GET /api/data/intervals - 列出支持的时间周期
    - 返回数据集基本信息（不包含敏感的存储路径）
    - _Requirements: 2.3.1, 2.3.2, 2.3.3_
  
  - [ ] 11.2 实现回测管理端点
    - POST /api/backtests - 创建新回测
    - GET /api/backtests/:id - 获取回测状态
    - GET /api/backtests/:id/result - 获取回测结果
    - DELETE /api/backtests/:id - 取消回测
    - GET /api/backtests - 列出用户的回测
    - _Requirements: 1.1, 1.3, 8.2_
  
  - [ ] 11.3 实现优化端点
    - POST /api/optimizations - 启动参数优化
    - GET /api/optimizations/:id - 获取优化状态
    - GET /api/optimizations/:id/results - 获取优化结果
    - DELETE /api/optimizations/:id - 取消优化
    - _Requirements: 5.1, 5.4_
  
  - [ ] 11.4 实现数据管理端点
    - POST /api/market-data/upload - 上传自定义数据
    - GET /api/market-data/sources - 列出可用数据源
    - GET /api/market-data/preview - 预览数据
    - DELETE /api/market-data/:id - 删除上传的数据
    - _Requirements: 2.3_
  
  - [ ] 11.5 实现报告端点
    - GET /api/backtests/:id/report/pdf - 下载PDF报告
    - GET /api/backtests/:id/report/csv - 下载CSV数据
    - GET /api/backtests/:id/report/json - 下载JSON数据
    - POST /api/backtests/:id/report/generate - 重新生成报告
    - _Requirements: 7.1, 7.2, 7.3_
  


  - [ ] 11.6 实现比较端点
    - POST /api/backtests/compare - 比较多个回测
    - GET /api/backtests/compare/:id - 获取比较结果
    - _Requirements: 8.4_

- [ ] 12. 构建历史数据管理前端UI（仅限本地访问）
  - [ ] 12.1 创建数据下载页面
    - 选择市场类型（spot、futures等）
    - 选择交易对（支持多选）
    - 选择时间周期（支持多选）
    - 选择日期范围
    - 显示预估下载大小和文件数量
    - 启动下载按钮
    - _Requirements: 2.1.1, 2.1.2, 2.1.3_
  
  - [ ] 12.2 创建下载进度页面
    - 显示所有下载任务列表

    - 实时显示下载进度条
    - 显示下载速度和剩余时间
    - 显示当前下载的文件
    - 支持取消下载
    - 显示失败文件列表和重试按钮
    - _Requirements: 2.1.4, 2.1.5_
  
  - [x] 12.3 创建数据集管理页面


    - 显示所有已下载数据集的表格
    - 显示交易对、市场类型、时间周期、时间范围
    - 显示数据点数量和文件大小
    - 支持按多个维度筛选
    - 支持排序（按大小、日期等）
    - 提供删除按钮（带确认）
    - _Requirements: 2.2.3, 2.2.4, 2.2.5, 2.2.6_
  
  - [ ] 12.4 创建存储统计仪表板
    - 显示总存储使用量和可用空间
    - 饼图显示按市场类型的分布
    - 柱状图显示按时间周期的分布
    - 显示最大和最小数据集
    - 显示数据覆盖时间线
    - 提供清理建议
    - _Requirements: 2.2.7, 2.2.10_
  
  - [ ] 12.5 创建数据验证页面
    - 列出所有验证记录
    - 显示验证状态（通过/失败）
    - 显示发现的问题列表
    - 支持手动触发验证
    - 显示数据缺口可视化
    - 提供修复建议
    - _Requirements: 2.2.8_
  
  - [ ] 12.6 实现本地访问检测
    - 检测当前访问URL是否为localhost
    - 非本地访问显示警告页面
    - 提供本地访问指引
    - _Requirements: 2.2.2_

- [ ] 13. 构建回测前端UI
  - [ ] 13.1 创建数据集选择组件（所有用户可访问）
    - 显示可用数据集列表
    - 按交易对、时间周期筛选
    - 显示数据覆盖时间范围
    - 显示数据质量指标
    - 支持自动选择最佳数据集
    - 支持手动选择特定数据集
    - _Requirements: 2.3.1, 2.3.2, 2.3.3, 2.3.4, 2.3.6, 2.3.7_
  
  - [ ] 13.2 创建回测配置页面
    - 选择策略模板
    - 配置策略参数
    - 集成数据集选择组件
    - 选择时间范围
    - 设置回测选项
    - 显示数据可用性提示
    - _Requirements: 1.1, 2.3.3, 2.3.5_
  
  - [ ] 13.3 创建回测进度页面
    - 显示实时进度条
    - 显示当前处理的数据点
    - 显示预计完成时间
    - 显示使用的数据集信息
    - 支持取消操作
    - _Requirements: 1.4, 2.3.8_
  
  - [ ] 13.4 创建回测结果页面
    - 显示关键性能指标
    - 展示权益曲线图
    - 展示回撤图
    - 显示交易列表
    - 显示使用的数据集信息
    - _Requirements: 4.1, 4.2, 4.3, 8.2, 8.3, 2.3.8_
  
  - [ ] 13.5 创建参数优化页面
    - 配置优化参数范围
    - 选择优化指标
    - 显示优化进度
    - 展示参数热力图
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ] 13.6 创建回测历史页面
    - 列出所有历史回测
    - 支持筛选和排序
    - 显示关键指标对比
    - 支持删除和导出
    - _Requirements: 8.1, 8.2, 8.3_
  
  - [ ] 13.7 创建回测比较页面
    - 选择多个回测进行比较
    - 并排显示指标
    - 叠加权益曲线
    - 生成对比报告
    - _Requirements: 8.4_

- [ ] 14. 实现实时回测功能
  - [ ] 10.1 创建实时数据更新机制
    - 定时获取最新市场数据
    - 增量更新回测结果
    - 触发策略重新执行
    - 更新性能指标
    - _Requirements: 9.1, 9.2_
  
  - [ ] 10.2 实现性能监控和警报
    - 监控关键指标变化
    - 设置警报阈值
    - 发送警报通知
    - 记录警报历史
    - _Requirements: 9.3_
  
  - [ ] 10.3 创建实时回测仪表板
    - 显示实时性能指标
    - 展示最新交易
    - 显示与历史回测的对比
    - 支持暂停和恢复
    - _Requirements: 9.1, 9.4, 9.5_

- [ ] 15. 实现多策略组合回测
  - [ ] 11.1 创建组合回测引擎
    - 支持多策略并行执行
    - 实现资金分配管理
    - 计算组合级别指标
    - 处理策略间依赖
    - _Requirements: 10.1, 10.2, 10.5_
  
  - [ ] 11.2 实现相关性分析
    - 计算策略间相关系数
    - 生成相关性矩阵
    - 识别分散化机会
    - 可视化相关性
    - _Requirements: 10.4_
  
  - [ ] 11.3 实现贡献度分析
    - 计算各策略收益贡献
    - 分析风险贡献
    - 识别最佳/最差策略
    - 生成贡献度报告
    - _Requirements: 10.3_

- [ ] 16. 实现高级风险分析
  - [ ] 12.1 实现压力测试
    - 模拟极端市场条件
    - 计算最坏情况损失
    - 测试策略稳健性
    - 生成压力测试报告
    - _Requirements: 11.2_
  
  - [ ] 12.2 实现情景分析
    - 定义市场情景
    - 模拟策略在各情景下的表现
    - 比较情景结果
    - 识别脆弱点
    - _Requirements: 11.2, 11.4_
  
  - [ ] 12.3 实现风险归因分析
    - 分解风险来源
    - 计算各因素贡献
    - 生成风险报告
    - 提供风险缓解建议
    - _Requirements: 11.1, 11.5_

- [ ] 17. 性能优化和监控
  - [ ] 13.1 实现缓存优化
    - 优化Redis缓存策略
    - 实现多级缓存
    - 添加缓存预热
    - 监控缓存命中率
    - _Requirements: 12.2_
  
  - [ ] 13.2 实现并行处理优化
    - 优化Worker线程池
    - 实现任务负载均衡
    - 添加资源监控
    - 动态调整并发
    - _Requirements: 12.1_
  
  - [ ] 13.3 实现数据库优化
    - 添加必要索引
    - 优化查询性能
    - 实现数据分区
    - 定期归档旧数据
    - _Requirements: 12.2_
  
  - [ ] 13.4 实现监控和日志
    - 添加性能监控指标
    - 实现详细日志记录
    - 创建监控仪表板
    - 设置性能警报
    - _Requirements: 12.5_

- [ ]* 18. 测试和文档
  - [ ]* 14.1 编写集成测试
    - 测试完整回测流程
    - 测试参数优化流程
    - 测试报告生成
    - 测试API端点
    - _Requirements: All_
  
  - [ ]* 14.2 编写性能测试
    - 测试大数据集回测
    - 测试并发处理
    - 测试缓存性能
    - 生成性能基准
    - _Requirements: 12.1, 12.2_
  
  - [ ]* 14.3 编写用户文档
    - 创建回测使用指南
    - 编写参数优化教程
    - 说明指标含义
    - 提供最佳实践
    - _Requirements: All_
  
  - [ ]* 14.4 编写API文档
    - 文档化所有端点
    - 提供请求/响应示例
    - 说明错误代码
    - 创建Postman集合
    - _Requirements: All_

## Notes

- 任务标记为 `*` 的是可选测试和文档任务
- 建议按顺序执行任务，因为后续任务依赖前面的实现
- 每个主要功能完成后应进行测试验证
- 优先实现核心回测功能，然后再添加高级功能
- 性能优化应该在基本功能稳定后进行
